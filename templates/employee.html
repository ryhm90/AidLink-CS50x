{% extends "layout.html" %}
{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}
{% block main %}
<script>
    var csrfToken = "{{ csrf_token() }}";
</script>

<!-- âœ… Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>

  <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
    <div class="d-flex">
      <div id="errorToastMessage" class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- âœ… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© -->
<div class="card shadow p-4">
  <form method="POST" action="{{ url_for('search_employees') }}" class="row mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="col-md-4">
      <input type="text" name="keyword" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø©" value="{{ keyword or '' }}">
    </div>
    <div class="col-md-4">
      <select name="locat_na" class="form-control">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>
        {% for loc in locations %}
        <option value="{{ loc }}" {% if loc == locat_na %}selected{% endif %}>{{ loc }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button>
      <a href="{{ url_for('export_employees_excel', keyword=keyword, locat_na=locat_na) }}" class="btn btn-outline-success">ğŸ“„ ØªØµØ¯ÙŠØ± Excel</a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
        â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
      </button>
    </div>
  </form>

  <!-- âœ… Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
  <div id="employee-section">
    {% include "partials/employee_section.html" %}
  </div>
</div>

<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addEmployeeForm" class="modal-content" onsubmit="event.preventDefault(); saveEmployee();">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% for label, name, type in [
          ('Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø©', 'nono', 'text'),
          ('Ø§Ù„Ø§Ø³Ù…', 'name', 'text'),
          ('Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„', 'type_work', 'text'),
          ('Ø§Ù„Ø¬Ù†Ø³', 'six_type', 'select'),
          ('Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©', 'mared', 'select'),
          ('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'date1', 'date'),
          ('Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'addres', 'text'),
          ('Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'locat_na', 'select')
        ] %}
        <div class="mb-3">
          <label class="form-label">{{ label }}</label>
          {% if type == 'select' %}
            <select name="{{ name }}" class="form-control">
              {% if name == 'six_type' %}
              <option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option>
              {% elif name == 'mared' %}
              <option>Ø£Ø¹Ø²Ø¨</option><option>Ù…ØªØ²ÙˆØ¬</option>
              {% elif name == 'locat_na' %}
              {% for loc in locations %}<option value="{{ loc }}">{{ loc }}</option>{% endfor %}
              {% endif %}
            </select>
          {% else %}
            <input type="{{ type }}" name="{{ name }}" class="form-control" required>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>
</div>

<script>
async function saveEmployee() {
  const form = document.getElementById("addEmployeeForm");
  const formData = new FormData(form);
  try {
    const res = await fetch("/add_employee", {
      method: "POST",
      body: formData
    });
    const html = await res.text();
    document.getElementById("employee-section").innerHTML = html;
    bootstrap.Modal.getInstance(document.getElementById("addEmployeeModal")).hide();
    new bootstrap.Toast(document.getElementById("successToast")).show();
  } catch (err) {
    document.getElementById("errorToastMessage").innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
    new bootstrap.Toast(document.getElementById("errorToast")).show();
  }
}
</script>
{% endblock %}
