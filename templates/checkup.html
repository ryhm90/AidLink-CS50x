{% extends "layout.html" %}
{% block title %}ÙØ­Øµ Ø·Ø¨ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù{% endblock %}
{% block main %}
<script>
async function saveCheckup() {
    const form = document.getElementById("checkup-form");
    const firstDate = new Date(form.first_date.value);
    const returnDate = new Date(form.return_date.value);

    if (form.return_date.value && returnDate <= firstDate) {
        alert("âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£ÙˆÙ„ÙŠ");
        return;
    }

    const formData = new FormData(form);
    try {
        const res = await fetch("/checkup/save", {
            method: "POST",
            body: formData
        });
        const html = await res.text();
        document.getElementById("checkup-section").innerHTML = html;

        const modal = bootstrap.Modal.getInstance(document.getElementById('newCheckupModal'));
        if (modal) modal.hide();
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        new bootstrap.Toast(document.getElementById("successToast")).show();
    } catch (err) {
        document.getElementById("errorToastMessage").innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸";
        new bootstrap.Toast(document.getElementById("errorToast")).show();
    }
}

async function deleteCheckup(formId) {
    const form = document.getElementById(formId);
    const formData = new FormData(form);

    try {
        const res = await fetch("/checkup/delete", {
            method: "POST",
            body: formData
        });
        const html = await res.text();
        document.getElementById("checkup-section").innerHTML = html;
        const modal = bootstrap.Modal.getInstance(document.getElementById(formId));
        if (modal) modal.hide();
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        new bootstrap.Toast(document.getElementById("successToastDelete")).show();
    } catch (err) {
        document.getElementById("errorToastMessage").innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù";
        new bootstrap.Toast(document.getElementById("errorToast")).show();
    }
}

async function updateCheckup(formId) {
    const form = document.getElementById(formId);
    const firstDate = new Date(form.first_date.value);
    const returnDate = new Date(form.return_date.value);

    if (form.return_date.value && returnDate <= firstDate) {
        alert("âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£ÙˆÙ„ÙŠ");
        return;
    }

    const formData = new FormData(form);
    try {
        const res = await fetch("/checkup/update", {
            method: "POST",
            body: formData
        });
        const html = await res.text();
        document.getElementById("checkup-section").innerHTML = html;

        const modal = bootstrap.Modal.getInstance(document.getElementById(formId));
        if (modal) modal.hide();
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        new bootstrap.Toast(document.getElementById("successToastUpdate")).show();
    } catch (err) {
        document.getElementById("errorToastMessage").innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
        new bootstrap.Toast(document.getElementById("errorToast")).show();
    }
}
async function searchchekup() {
  const formData = new FormData(document.getElementById('searchForm'));
  const response = await fetch('/checkup', {
    method: 'POST',
    body: formData
  });
  const html = await response.text();
  document.getElementById('checkup-section').innerHTML = html;
}

</script>

<h4 class="mb-3">Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h4>
<form method="POST" id="searchForm" class="row g-2 mb-4" onsubmit="event.preventDefault(); searchchekup();">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="col-auto">
    <input type="text" name="nono" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù" value="{{ nono or '' }}" required>
</div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button>
</div>
</form>

<div id="checkup-section">
    {% if emp %}
      {% include "partials/checkup_section.html" %}
    {% endif %}
  </div>
  
{% endblock %}
